<?php

namespace App\Services;

use App\Models\User;
use App\Models\UserTelegramSettings;
use Carbon\Carbon;
use Illuminate\Support\Facades\Log;

class TelegramCommandHandler
{
    protected UserTelegramService $telegramService;

    public function __construct(UserTelegramService $telegramService)
    {
        $this->telegramService = $telegramService;
    }

    /**
     * Handle incoming command
     */
    public function handle(string $text, UserTelegramSettings $settings): void
    {
        $text = trim($text);
        
        if (!str_starts_with($text, '/')) {
            return;
        }

        // Parse command and arguments
        $parts = preg_split('/\s+/', $text, 3);
        $command = strtolower($parts[0]);
        $args = array_slice($parts, 1);

        $user = $settings->user;

        try {
            switch ($command) {
                case '/start':
                    $this->handleStart($user, $settings);
                    break;

                case '/help':
                    $this->handleHelp($user, $settings);
                    break;

                case '/devices':
                    $period = $args[0] ?? null;
                    $filter = $args[1] ?? null;
                    $this->handleDevices($user, $settings, $period, $filter);
                    break;

                default:
                    $this->sendMessage($settings, "‚ùå Unknown command. Use /help to see available commands.");
            }
        } catch (\Exception $e) {
            Log::error('Telegram command error', [
                'command' => $command,
                'user_id' => $user->id,
                'error' => $e->getMessage(),
            ]);
            
            $this->sendMessage($settings, "‚ùå Error: " . $e->getMessage());
        }
    }

    /**
     * Handle /start command
     */
    protected function handleStart(User $user, UserTelegramSettings $settings): void
    {
        if (!$settings->isConfigured()) {
            $message = "üëã Ch√†o m·ª´ng ƒë·∫øn v·ªõi Email Registration Bot!\n\n";
            $message .= "‚ùå Telegram ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh ho√†n ch·ªânh.\n";
            $message .= "Vui l√≤ng v√†o admin panel ƒë·ªÉ setup bot token v√† chat ID.";
            $this->sendMessage($settings, $message);
            return;
        }

        $message = "üëã Ch√†o m·ª´ng ƒë·∫øn v·ªõi Email Registration Bot!\n\n";
        $message .= "üìã <b>Command c√≥ s·∫µn:</b>\n\n";
        $message .= "<b>/devices [period] [filter]</b>\n";
        $message .= "Xem danh s√°ch thi·∫øt b·ªã v√† th·ªëng k√™ email registration\n\n";
        $message .= "<b>Parameters:</b>\n";
        $message .= "‚Ä¢ [period] - today, week, month, &lt;n&gt;h, &lt;n&gt;m, &lt;n&gt;d\n";
        $message .= "‚Ä¢ [filter] - active (c√≥ email), inactive (kh√¥ng c√≥ email)\n\n";
        $message .= "<b>V√≠ d·ª•:</b>\n";
        $message .= "/devices              ‚Üí T·∫•t c·∫£ devices\n";
        $message .= "/devices today        ‚Üí Devices h√¥m nay\n";
        $message .= "/devices 2h           ‚Üí Devices trong 2 gi·ªù g·∫ßn ƒë√¢y\n";
        $message .= "/devices 30m          ‚Üí Devices trong 30 ph√∫t g·∫ßn ƒë√¢y\n";
        $message .= "/devices week active  ‚Üí Ch·ªâ active devices trong tu·∫ßn\n";
        $message .= "/devices 1h inactive ‚Üí Ch·ªâ inactive devices trong 1 gi·ªù\n\n";
        $message .= "üìñ G√µ /help ƒë·ªÉ xem t√†i li·ªáu ƒë·∫ßy ƒë·ªß";

        $this->sendMessage($settings, $message);
    }

    /**
     * Handle /help command
     */
    protected function handleHelp(User $user, UserTelegramSettings $settings): void
    {
        $message = "üìñ <b>T√†i li·ªáu h∆∞·ªõng d·∫´n /devices</b>\n\n";
        $message .= "<b>Command:</b> /devices [period] [filter]\n\n";
        $message .= "<b>M·ª•c ƒë√≠ch:</b>\n";
        $message .= "Danh s√°ch thi·∫øt b·ªã v√† th·ªëng k√™ email registration theo th·ªùi gian\n\n";
        $message .= "<b>Parameters:</b>\n\n";
        $message .= "<b>[period] - Th·ªùi gian:</b>\n";
        $message .= "‚Ä¢ today - H√¥m nay (00:00 - hi·ªán t·∫°i)\n";
        $message .= "‚Ä¢ week - Tu·∫ßn n√†y (Monday 00:00 - hi·ªán t·∫°i)\n";
        $message .= "‚Ä¢ month - Th√°ng n√†y (ng√†y 1 00:00 - hi·ªán t·∫°i)\n";
        $message .= "‚Ä¢ &lt;n&gt;h - N gi·ªù g·∫ßn ƒë√¢y (vd: 1h, 2h, 24h)\n";
        $message .= "‚Ä¢ &lt;n&gt;m - N ph√∫t g·∫ßn ƒë√¢y (vd: 30m, 60m, 120m)\n";
        $message .= "‚Ä¢ &lt;n&gt;d - N ng√†y g·∫ßn ƒë√¢y (vd: 7d, 30d)\n";
        $message .= "‚Ä¢ (ƒë·ªÉ tr·ªëng) - T·∫•t c·∫£ th·ªùi gian\n\n";
        $message .= "<b>[filter] - L·ªçc:</b>\n";
        $message .= "‚Ä¢ active - Ch·ªâ thi·∫øt b·ªã c√≥ ho·∫°t ƒë·ªông (c√≥ email)\n";
        $message .= "‚Ä¢ inactive - Ch·ªâ thi·∫øt b·ªã kh√¥ng c√≥ ho·∫°t ƒë·ªông (kh√¥ng c√≥ email)\n";
        $message .= "‚Ä¢ (ƒë·ªÉ tr·ªëng) - Hi·ªÉn th·ªã c·∫£ active v√† inactive\n\n";
        $message .= "<b>V√≠ d·ª• s·ª≠ d·ª•ng:</b>\n";
        $message .= "/devices\n";
        $message .= "/devices today\n";
        $message .= "/devices 2h\n";
        $message .= "/devices 30m\n";
        $message .= "/devices week active\n";
        $message .= "/devices month inactive\n";
        $message .= "/devices 1h active\n";
        $message .= "/devices 30m inactive\n\n";
        $message .= "G√µ /start ƒë·ªÉ xem h∆∞·ªõng d·∫´n nhanh";

        $this->sendMessage($settings, $message);
    }

    /**
     * Handle /devices command
     */
    protected function handleDevices(User $user, UserTelegramSettings $settings, ?string $period, ?string $filter): void
    {
        // Parse period to get start time
        $startTime = $this->parsePeriod($period);
        $periodLabel = $this->getPeriodLabel($period);

        // Get registrations in period
        $query = $user->registrations();
        if ($startTime) {
            $query->where('created_at', '>=', $startTime);
        }
        $registrations = $query->get();

        // Group by device fingerprint
        $fingerprintToCount = [];
        foreach ($registrations->groupBy('device_fingerprint') as $fingerprint => $regs) {
            $fingerprintToCount[$fingerprint] = $regs->count();
        }

        // Get all user devices
        $userDevices = $user->devices()->get(['device_fingerprint', 'device_name']);
        
        if ($userDevices->isEmpty()) {
            $this->sendMessage($settings, "üì± Kh√¥ng t√¨m th·∫•y thi·∫øt b·ªã n√†o trong h·ªá th·ªëng.");
            return;
        }

        // Build device stats
        $deviceStats = [];
        foreach ($userDevices as $device) {
            $count = $fingerprintToCount[$device->device_fingerprint] ?? 0;
            $deviceStats[] = [
                'device_name' => $device->device_name ?: 'Unknown Device',
                'registrations' => $count,
            ];
        }

        // Sort by registration count (descending)
        usort($deviceStats, function ($a, $b) {
            return $b['registrations'] - $a['registrations'];
        });

        // Filter by active/inactive
        if ($filter === 'active') {
            $deviceStats = array_filter($deviceStats, fn($d) => $d['registrations'] > 0);
        } elseif ($filter === 'inactive') {
            $deviceStats = array_filter($deviceStats, fn($d) => $d['registrations'] === 0);
        }

        $deviceStats = array_values($deviceStats);

        if (empty($deviceStats)) {
            $filterText = $filter ? " ({$filter})" : "";
            $this->sendMessage($settings, "üì± Kh√¥ng t√¨m th·∫•y thi·∫øt b·ªã{$filterText} trong kho·∫£ng th·ªùi gian {$periodLabel}.");
            return;
        }

        // Format message
        $message = "üì± <b>Device Statistics [{$periodLabel}]</b>\n\n";

        $activeDevices = array_filter($deviceStats, fn($d) => $d['registrations'] > 0);
        $inactiveDevices = array_filter($deviceStats, fn($d) => $d['registrations'] === 0);

        if ($filter === 'active') {
            $message .= "<b>Active Devices (" . count($activeDevices) . "):</b>\n";
            foreach ($activeDevices as $device) {
                $message .= "‚Ä¢ <code>{$device['device_name']}</code>: <b>{$device['registrations']}</b> emails\n";
            }
            $message .= "\nTotal: " . count($activeDevices) . " devices with activity";
        } elseif ($filter === 'inactive') {
            $message .= "<b>Inactive Devices (" . count($inactiveDevices) . "):</b>\n";
            foreach ($inactiveDevices as $device) {
                $message .= "‚Ä¢ <code>{$device['device_name']}</code>: <b>{$device['registrations']}</b> emails\n";
            }
            $message .= "\nTotal: " . count($inactiveDevices) . " devices without activity";
        } else {
            if (!empty($activeDevices)) {
                $message .= "<b>Active Devices (" . count($activeDevices) . "):</b>\n";
                foreach ($activeDevices as $device) {
                    $message .= "‚Ä¢ <code>{$device['device_name']}</code>: <b>{$device['registrations']}</b> emails\n";
                }
                $message .= "\n";
            }

            if (!empty($inactiveDevices)) {
                $message .= "<b>Inactive Devices (" . count($inactiveDevices) . "):</b>\n";
                foreach ($inactiveDevices as $device) {
                    $message .= "‚Ä¢ <code>{$device['device_name']}</code>: <b>{$device['registrations']}</b> emails\n";
                }
                $message .= "\n";
            }

            $message .= "üìä <b>Summary:</b>\n";
            $message .= "Total Devices: " . count($deviceStats) . "\n";
            $message .= "Active: " . count($activeDevices) . " (" . round(count($activeDevices) / count($deviceStats) * 100, 1) . "%)\n";
            $message .= "Inactive: " . count($inactiveDevices) . " (" . round(count($inactiveDevices) / count($deviceStats) * 100, 1) . "%)";
        }

        $this->sendMessage($settings, $message);
    }

    /**
     * Parse period string to Carbon datetime
     */
    protected function parsePeriod(?string $period): ?Carbon
    {
        if (!$period) {
            return null;
        }

        $period = strtolower(trim($period));

        switch ($period) {
            case 'today':
                return Carbon::today();
            
            case 'week':
                return Carbon::now()->startOfWeek();
            
            case 'month':
                return Carbon::now()->startOfMonth();
            
            default:
                // Try to parse hours: 1h, 2h, 24h
                if (preg_match('/^(\d+)h$/i', $period, $matches)) {
                    return Carbon::now()->subHours((int)$matches[1]);
                }
                
                // Try to parse minutes: 30m, 60m
                if (preg_match('/^(\d+)m$/i', $period, $matches)) {
                    return Carbon::now()->subMinutes((int)$matches[1]);
                }
                
                // Try to parse days: 7d, 30d
                if (preg_match('/^(\d+)d$/i', $period, $matches)) {
                    return Carbon::now()->subDays((int)$matches[1]);
                }
                
                throw new \InvalidArgumentException("Invalid period format: {$period}");
        }
    }

    /**
     * Get human-readable period label
     */
    protected function getPeriodLabel(?string $period): string
    {
        if (!$period) {
            return 'All Time';
        }

        $period = strtolower(trim($period));

        switch ($period) {
            case 'today':
                return 'Today';
            case 'week':
                return 'This Week';
            case 'month':
                return 'This Month';
            default:
                return ucfirst($period);
        }
    }

    /**
     * Send message via Telegram service
     */
    protected function sendMessage(UserTelegramSettings $settings, string $message): void
    {
        $user = $settings->user;
        $telegramService = new UserTelegramService($user, $settings);
        $telegramService->sendMessage($message);
    }
}
